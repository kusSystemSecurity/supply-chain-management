import { useState, useEffect } from "react"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog"
import { Loading } from "@/components/loading"
import { AlertTriangle, ExternalLink, Calendar, Shield, AlertCircle } from "lucide-react"
import { cveApi } from "@/services/api"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { ScrollArea } from "@/components/ui/scroll-area"

interface CVEDetailsModalProps {
    cveId: string
    packageName?: string | null
    packageVersion?: string | null
    severity?: string
    cvssScore?: number | null
    epssScore?: number | null
    open: boolean
    onOpenChange: (open: boolean) => void
}

interface CVEDetails {
    cveId?: string
    cve?: string
    summary?: string
    description?: string
    publishedDate?: string
    published_date?: string
    modifiedDate?: string
    modified_date?: string
    cvssScore?: number
    cvss_score?: number
    cvssSeverity?: string
    cvss_severity?: string
    cvssVector?: string
    cvss_vector?: string
    affectedCPEs?: Array<{
        cpe?: string
        version?: string
        [key: string]: any
    }>
    affected_cpes?: Array<{
        cpe?: string
        version?: string
        [key: string]: any
    }>
    riskScore?: {
        overall?: number
        exploitability?: number
        impact?: number
    }
    risk_score?: {
        overall?: number
        exploitability?: number
        impact?: number
    }
    alternativeIds?: string[]
    alternative_ids?: string[]
    references?: Array<{
        url?: string
        source?: string
        [key: string]: any
    }>
    [key: string]: any
}

export function CVEDetailsModal({
    cveId,
    packageName,
    packageVersion,
    severity,
    cvssScore,
    epssScore,
    open,
    onOpenChange,
}: CVEDetailsModalProps) {
    const [details, setDetails] = useState<CVEDetails | null>(null)
    const [loading, setLoading] = useState(false)
    const [error, setError] = useState<string | null>(null)

    useEffect(() => {
        if (open && cveId) {
            fetchCVEDetails()
        } else {
            setDetails(null)
            setError(null)
        }
    }, [open, cveId])

    const fetchCVEDetails = async () => {
        try {
            setLoading(true)
            setError(null)
            const data = await cveApi.getDetails(cveId)
            setDetails(data as CVEDetails)
        } catch (err) {
            setError(err instanceof Error ? err.message : "Failed to fetch CVE details")
        } finally {
            setLoading(false)
        }
    }

    const getSeverityColor = (severity?: string) => {
        if (!severity) return "bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"
        switch (severity.toUpperCase()) {
            case "CRITICAL":
                return "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"
            case "HIGH":
                return "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200"
            case "MEDIUM":
                return "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"
            case "LOW":
                return "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
            default:
                return "bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"
        }
    }

    const formatDate = (dateString?: string) => {
        if (!dateString) return "N/A"
        try {
            return new Date(dateString).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
            })
        } catch {
            return dateString
        }
    }

    // Helper function to get nested values with fallback
    const getValue = (obj: any, ...keys: string[]): any => {
        if (!obj) return undefined
        for (const key of keys) {
            if (obj[key] !== undefined && obj[key] !== null) {
                return obj[key]
            }
        }
        return undefined
    }

    const displaySummary = details ? getValue(details, "summary", "description") : undefined
    const displayPublishedDate = details ? getValue(details, "publishedDate", "published_date") : undefined
    const displayModifiedDate = details ? getValue(details, "modifiedDate", "modified_date") : undefined
    const displayCvssScore = details ? getValue(details, "cvssScore", "cvss_score") : undefined
    const displayCvssSeverity = details ? getValue(details, "cvssSeverity", "cvss_severity") : undefined
    const displayCvssVector = details ? getValue(details, "cvssVector", "cvss_vector") : undefined
    const displayAffectedCPEs = details ? (getValue(details, "affectedCPEs", "affected_cpes") || []) : []
    const displayRiskScore = details ? getValue(details, "riskScore", "risk_score") : undefined
    const displayAlternativeIds = details ? (getValue(details, "alternativeIds", "alternative_ids") || []) : []
    const displayReferences = details?.references || []

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="max-w-4xl max-h-[90vh]">
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2">
                        <Shield className="h-5 w-5" />
                        {cveId}
                    </DialogTitle>
                    <DialogDescription>
                        {packageName && (
                            <span>
                                Package: {packageName}
                                {packageVersion && ` (${packageVersion})`}
                            </span>
                        )}
                    </DialogDescription>
                </DialogHeader>

                {loading ? (
                    <div className="flex items-center justify-center py-8">
                        <Loading size="lg" />
                    </div>
                ) : error ? (
                    <div className="flex flex-col items-center justify-center py-8 space-y-2">
                        <AlertTriangle className="h-8 w-8 text-destructive" />
                        <p className="text-destructive font-medium">Failed to load CVE details</p>
                        <p className="text-sm text-muted-foreground">{error}</p>
                        <Button variant="outline" size="sm" onClick={fetchCVEDetails}>
                            Retry
                        </Button>
                    </div>
                ) : details ? (
                    <ScrollArea className="max-h-[calc(90vh-120px)] pr-4">
                        <div className="space-y-6">
                            {/* Severity and Scores */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {severity && (
                                    <div className="space-y-1">
                                        <p className="text-xs text-muted-foreground">Severity</p>
                                        <Badge className={getSeverityColor(severity)}>{severity}</Badge>
                                    </div>
                                )}
                                {(cvssScore !== null && cvssScore !== undefined) || displayCvssScore ? (
                                    <div className="space-y-1">
                                        <p className="text-xs text-muted-foreground">CVSS Score</p>
                                        <p className="text-lg font-semibold">
                                            {(cvssScore ?? displayCvssScore)?.toFixed(1)}
                                        </p>
                                    </div>
                                ) : null}
                                {epssScore !== null && epssScore !== undefined && (
                                    <div className="space-y-1">
                                        <p className="text-xs text-muted-foreground">EPSS Score</p>
                                        <p className="text-lg font-semibold">{(epssScore * 100).toFixed(2)}%</p>
                                    </div>
                                )}
                                {displayCvssSeverity && (
                                    <div className="space-y-1">
                                        <p className="text-xs text-muted-foreground">CVSS Severity</p>
                                        <Badge className={getSeverityColor(displayCvssSeverity)}>
                                            {displayCvssSeverity}
                                        </Badge>
                                    </div>
                                )}
                            </div>

                            <Separator />

                            {/* Summary */}
                            {displaySummary && (
                                <div className="space-y-2">
                                    <h3 className="text-sm font-semibold flex items-center gap-2">
                                        <AlertCircle className="h-4 w-4" />
                                        Description
                                    </h3>
                                    <p className="text-sm text-muted-foreground leading-relaxed">
                                        {displaySummary}
                                    </p>
                                </div>
                            )}

                            {/* Dates */}
                            {(displayPublishedDate || displayModifiedDate) && (
                                <>
                                    <Separator />
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {displayPublishedDate && (
                                            <div className="space-y-1">
                                                <p className="text-xs text-muted-foreground flex items-center gap-1">
                                                    <Calendar className="h-3 w-3" />
                                                    Published Date
                                                </p>
                                                <p className="text-sm">{formatDate(displayPublishedDate)}</p>
                                            </div>
                                        )}
                                        {displayModifiedDate && (
                                            <div className="space-y-1">
                                                <p className="text-xs text-muted-foreground flex items-center gap-1">
                                                    <Calendar className="h-3 w-3" />
                                                    Modified Date
                                                </p>
                                                <p className="text-sm">{formatDate(displayModifiedDate)}</p>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}

                            {/* CVSS Vector */}
                            {displayCvssVector && (
                                <>
                                    <Separator />
                                    <div className="space-y-2">
                                        <h3 className="text-sm font-semibold">CVSS Vector</h3>
                                        <code className="text-xs bg-muted p-2 rounded block break-all">
                                            {displayCvssVector}
                                        </code>
                                    </div>
                                </>
                            )}

                            {/* Risk Scores */}
                            {displayRiskScore && (
                                <>
                                    <Separator />
                                    <div className="space-y-2">
                                        <h3 className="text-sm font-semibold">Risk Scores</h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            {displayRiskScore.overall !== undefined && (
                                                <div className="space-y-1">
                                                    <p className="text-xs text-muted-foreground">Overall</p>
                                                    <p className="text-lg font-semibold">
                                                        {displayRiskScore.overall.toFixed(1)}
                                                    </p>
                                                </div>
                                            )}
                                            {displayRiskScore.exploitability !== undefined && (
                                                <div className="space-y-1">
                                                    <p className="text-xs text-muted-foreground">Exploitability</p>
                                                    <p className="text-lg font-semibold">
                                                        {displayRiskScore.exploitability.toFixed(1)}
                                                    </p>
                                                </div>
                                            )}
                                            {displayRiskScore.impact !== undefined && (
                                                <div className="space-y-1">
                                                    <p className="text-xs text-muted-foreground">Impact</p>
                                                    <p className="text-lg font-semibold">
                                                        {displayRiskScore.impact.toFixed(1)}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* Affected CPEs */}
                            {displayAffectedCPEs.length > 0 && (
                                <>
                                    <Separator />
                                    <div className="space-y-2">
                                        <h3 className="text-sm font-semibold">Affected CPEs</h3>
                                        <ScrollArea className="h-40">
                                            <div className="space-y-1">
                                                {displayAffectedCPEs.map((cpe: any, index: number) => (
                                                    <div key={index} className="text-xs bg-muted p-2 rounded">
                                                        {cpe.cpe || cpe.version || (typeof cpe === 'string' ? cpe : JSON.stringify(cpe))}
                                                    </div>
                                                ))}
                                            </div>
                                        </ScrollArea>
                                    </div>
                                </>
                            )}

                            {/* Alternative IDs */}
                            {displayAlternativeIds.length > 0 && (
                                <>
                                    <Separator />
                                    <div className="space-y-2">
                                        <h3 className="text-sm font-semibold">Alternative IDs</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {displayAlternativeIds.map((id: string, index: number) => (
                                                <Badge key={index} variant="outline">
                                                    {id}
                                                </Badge>
                                            ))}
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* References */}
                            {displayReferences.length > 0 && (
                                <>
                                    <Separator />
                                    <div className="space-y-2">
                                        <h3 className="text-sm font-semibold">References</h3>
                                        <div className="space-y-1">
                                            {displayReferences.map((ref: any, index: number) => {
                                                const url = ref.url || (typeof ref === 'string' ? ref : null)
                                                if (!url) return null
                                                return (
                                                    <a
                                                        key={index}
                                                        href={url}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex items-center gap-2 text-sm text-primary hover:underline"
                                                    >
                                                        <ExternalLink className="h-3 w-3" />
                                                        {ref.source || url}
                                                    </a>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* External Link */}
                            <Separator />
                            <div className="pt-2">
                                <a
                                    href={`https://www.cvedetails.com/cve/${cveId}/`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex items-center gap-2 text-sm text-primary hover:underline"
                                >
                                    <ExternalLink className="h-4 w-4" />
                                    View on CVEDetails.com
                                </a>
                            </div>
                        </div>
                    </ScrollArea>
                ) : null}
            </DialogContent>
        </Dialog>
    )
}

